<% layout("/layouts/boilerplate.ejs") %>

<div class="container mt-4">
  <div class="listing-hero mb-4">
    <img src="<%= listing.image.url%>" alt="<%= listing.title%>" />
    <div class="listing-title-overlay">
      <h1><%=listing.title%></h1>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="info-card">
        <div class="section-header">
          <i class="fa-solid fa-circle-info"></i>
          <h3>Property Details</h3>
        </div>

        <div class="owner-badge">
          <i class="fa-solid fa-user-tie"></i>
          <span><strong>Hosted by:</strong> <%=listing.owner.username%></span>
        </div>

        <div class="price-tag">
          <i class="fa-solid fa-indian-rupee-sign"></i>
          <%= listing.price.toLocaleString("en-IN") %> <small>/ night</small>
        </div>

        <div class="description-text">
          <p><%= listing.description %></p>
        </div>

        <hr class="my-4" />

        <div class="info-item">
          <i class="fa-solid fa-location-dot"></i>
          <div>
            <strong>Location</strong>
            <p class="mb-0 text-muted"><%=listing.location%></p>
          </div>
        </div>

        <div class="info-item">
          <i class="fa-solid fa-earth-americas"></i>
          <div>
            <strong>Country</strong>
            <p class="mb-0 text-muted"><%=listing.country%></p>
          </div>
        </div>
      </div>

      <%if(currentUser && listing.owner._id.equals(currentUser._id) ){%>
      <div class="info-card">
        <div class="section-header">
          <i class="fa-solid fa-toolbox"></i>
          <h3>Manage Listing</h3>
        </div>
        <div class="action-buttons">
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary">
            <i class="fa-solid fa-pen-to-square"></i> Edit Listing
          </a>
          <form
            method="POST"
            action="/listings/<%= listing._id %>?_method=DELETE"
            onsubmit="return confirm('Are you sure you want to delete this listing?')"
            style="flex: 1"
          >
            <button class="btn btn-danger w-100">
              <i class="fa-solid fa-trash"></i> Delete Listing
            </button>
          </form>
        </div>
      </div>
      <%}%>

      <div class="review-section">
        <div class="section-header">
          <i class="fa-solid fa-star"></i>
          <h3>Guest Reviews (<%=listing.reviews.length%>)</h3>
        </div>

        <%if(currentUser){%>
        <div class="review-form-card">
          <h5 class="mb-4">
            <i class="fa-solid fa-comment-dots"></i> Share Your Experience
          </h5>
          <form
            action="/listings/<%=listing._id%>/reviews"
            method="POST"
            novalidate
            class="needs-validation"
          >
            <div class="mb-4">
              <label for="rating" class="form-label"
                ><strong>Rating:</strong></label
              >
              <fieldset class="starability-coinFlip">
                <input
                  type="radio"
                  id="no-rate"
                  class="input-no-rate"
                  name="review[rating]"
                  value="1"
                  checked
                  aria-label="No rating."
                />
                <input
                  type="radio"
                  id="first-rate1"
                  name="review[rating]"
                  value="1"
                />
                <label for="first-rate1" title="Terrible">1 star</label>
                <input
                  type="radio"
                  id="first-rate2"
                  name="review[rating]"
                  value="2"
                />
                <label for="first-rate2" title="Not good">2 stars</label>
                <input
                  type="radio"
                  id="first-rate3"
                  name="review[rating]"
                  value="3"
                />
                <label for="first-rate3" title="Average">3 stars</label>
                <input
                  type="radio"
                  id="first-rate4"
                  name="review[rating]"
                  value="4"
                />
                <label for="first-rate4" title="Very good">4 stars</label>
                <input
                  type="radio"
                  id="first-rate5"
                  name="review[rating]"
                  value="5"
                />
                <label for="first-rate5" title="Amazing">5 stars</label>
              </fieldset>
            </div>

            <div class="mb-4">
              <label for="comment" class="form-label"
                ><strong>Your Review:</strong></label
              >
              <textarea
                name="review[comment]"
                id="comment"
                rows="4"
                class="form-control"
                required
                placeholder="Tell us about your experience at this property..."
              ></textarea>
              <div class="invalid-feedback">Please write a review</div>
            </div>
            <button class="btn btn-primary w-100">
              <i class="fa-solid fa-paper-plane"></i> Submit Review
            </button>
          </form>
        </div>
        <%}%> <% if(listing.reviews.length > 0) { %>
        <div class="row">
          <%for(review of listing.reviews){%>
          <div class="col-md-6">
            <div class="review-card">
              <div class="review-header">
                <div class="review-author">
                  <div class="review-avatar">
                    <%=review.author.username.charAt(0).toUpperCase()%>
                  </div>
                  <div>
                    <h6 class="mb-0"><%=review.author.username%></h6>
                    <p
                      class="starability-result mb-0"
                      data-rating="<%=review.rating%>"
                    ></p>
                  </div>
                </div>
                <%if(currentUser &&
                review.author._id.equals(currentUser._id)){%>
                <form
                  action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                  method="POST"
                >
                  <button class="btn btn-sm btn-outline-danger" type="submit">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </form>
                <%}%>
              </div>
              <p class="mt-3 mb-0"><%=review.comment%></p>
            </div>
          </div>
          <%}%>
        </div>
        <% } else { %>
        <div class="no-reviews">
          <i class="fa-regular fa-comment-dots"></i>
          <h5>No reviews yet</h5>
          <p>Be the first to share your experience!</p>
        </div>
        <% } %>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="info-card sticky-top" style="top: 110px">
        <h4 class="mb-4">
          <i class="fa-solid fa-indian-rupee-sign"></i>
          <%= listing.price.toLocaleString("en-IN") %>
          <small class="text-muted">/ night</small>
        </h4>

        <%if(!currentUser){%>
        <div class="alert alert-info">
          <i class="fa-solid fa-circle-info"></i>
          <a href="/login" class="alert-link">Login</a> to book this property or
          leave a review
        </div>
        <%}%>

        <div class="info-item">
          <i class="fa-solid fa-map-pin"></i>
          <div>
            <small class="text-muted">Location</small>
            <p class="mb-0">
              <strong><%=listing.location%>, <%=listing.country%></strong>
            </p>
          </div>
        </div>

        <div class="info-item">
          <i class="fa-solid fa-star"></i>
          <div>
            <small class="text-muted">Reviews</small>
            <p class="mb-0">
              <strong><%=listing.reviews.length%> guest reviews</strong>
            </p>
          </div>
        </div>

        <div class="info-item">
          <i class="fa-solid fa-user-tie"></i>
          <div>
            <small class="text-muted">Host</small>
            <p class="mb-0"><strong><%=listing.owner.username%></strong></p>
          </div>
        </div>

        <a
          href="/listings/<%= listing._id %>/book"
          class="btn btn-success w-100 mt-4"
        >
          <i class="fa-solid fa-calendar-check"></i> Book Now
        </a>
      </div>
    </div>
  </div>
</div>
